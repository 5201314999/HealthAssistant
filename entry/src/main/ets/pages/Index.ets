import  router  from '@ohos.router';
import { HealthDataManager } from '../utils/HealthDataManager';
import { BuiltInTemplates } from '../config/BuiltInTemplates';
import { DiseaseTemplate } from '../models/DiseaseTemplate';

@Entry
@Component
struct Index {
  @State templates: DiseaseTemplate[] = [];
  @State templateCounts: Map<string, number> = new Map();
  @State medicineCount: number = 0;
  @State todayMedicineCount: number = 0;
  @State cardScales: Map<string, number> = new Map(); // å¡ç‰‡ç¼©æ”¾åŠ¨ç”»çŠ¶æ€

  async aboutToAppear() {
    // åˆå§‹åŒ–æ•°æ®ç®¡ç†å™¨
    await HealthDataManager.getInstance().init(getContext(this));
    
    // åŠ è½½æ¨¡æ¿åˆ—è¡¨
    this.templates = BuiltInTemplates.getAllTemplates();
    
    // åŠ è½½ç»Ÿè®¡æ•°æ®
    await this.loadStatistics();
    
    // ç”Ÿæˆä»Šæ—¥ç”¨è¯è®°å½•
    await HealthDataManager.getInstance().generateTodayMedicineRecords();
  }

  onPageShow() {
    this.loadStatistics();
  }

  async loadStatistics() {
    // åŠ è½½å„æ¨¡æ¿çš„è®°å½•æ•°é‡
    for (const template of this.templates) {
      const count = await HealthDataManager.getInstance().getRecordCount(template.id);
      this.templateCounts.set(template.id, count);
    }
    
    // åŠ è½½ç”¨è¯æ•°æ®
    const medicineList = await HealthDataManager.getInstance().getMedicineList();
    const todayRecords = await HealthDataManager.getInstance().getMedicineRecords(Date.now());
    
    this.medicineCount = medicineList.length;
    this.todayMedicineCount = todayRecords.filter(r => !r.taken).length;
    
    // è§¦å‘UIæ›´æ–°
    this.templateCounts = new Map(this.templateCounts);
  }

  build() {
    Column() {
      // ç¾åŒ–æ ‡é¢˜æ  - æ·»åŠ æ¸å˜èƒŒæ™¯
      Row() {
        Column() {
          Text("æ…¢æ€§ç—…åŠ©æ‰‹")
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FFFFFF')
          
          Text('æ‚¨çš„å¥åº·ç®¡ç†ä¸“å®¶')
            .fontSize(12)
            .fontColor('#E0F7FA')
            .margin({ top: 4 })
        }
        .alignItems(HorizontalAlign.Start)
        
        Blank()
        
        // å¼•å¯¼æŒ‰é’®
        Text('ğŸ“–')
          .fontSize(24)
          .onClick(() => {
            router.pushUrl({ url: 'pages/GuidePage' });
          })
      }
      .width('100%')
      .height(100)
      .padding({ left: 20, right: 20, top: 16, bottom: 16 })
      .linearGradient({
        angle: 135,
        colors: [[0x4CAF50, 0.0], [0x2E7D32, 1.0]]
      })

      Scroll() {
        Column({ space: 20 }) {
          // ä»Šæ—¥æé†’å¡ç‰‡ - ç¾åŒ–ç‰ˆ
          if (this.todayMedicineCount > 0) {
            Column() {
              Row() {
                Text('â°')
                  .fontSize(28)
                
                Column({ space: 4 }) {
                  Text(`æ‚¨æœ‰ ${this.todayMedicineCount} æ¬¡ç”¨è¯å¾…æ‰“å¡`)
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#E65100')
                  
                  Text('æŒ‰æ—¶æœè¯ï¼Œå¥åº·ç”Ÿæ´»')
                    .fontSize(12)
                    .fontColor('#FB8C00')
                }
                .alignItems(HorizontalAlign.Start)
                .layoutWeight(1)
                .margin({ left: 12 })
                
                Text('å»æŸ¥çœ‹ â†’')
                  .fontSize(14)
                  .fontColor('#FF6F00')
                  .fontWeight(FontWeight.Medium)
              }
              .width('100%')
              .padding(16)
            }
            .width('100%')
            .margin({ left: 16, right: 16, top: 16 })
            .linearGradient({
              angle: 90,
              colors: [[0xFFE0B2, 0.0], [0xFFCC80, 1.0]]
            })
            .borderRadius(16)
            .shadow({
              radius: 12,
              color: '#30FF9800',
              offsetY: 4
            })
            .onClick(() => {
              router.pushUrl({ url: 'pages/MedicineManagePage' });
            })
          }

          // æ…¢æ€§ç—…åŠ©æ‰‹åŒºåŸŸ
          Column({ space: 12 }) {
            Text('æ…¢æ€§ç—…åŠ©æ‰‹')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .alignSelf(ItemAlign.Start)

            // åŠ¨æ€ç”Ÿæˆç–¾ç—…æ¨¡æ¿å¡ç‰‡
            ForEach(this.templates, (template: DiseaseTemplate) => {
              this.ManageCard(
                template.name,
                template.description,
                template.color,
                this.templateCounts.get(template.id) || 0,
                () => {
                  router.pushUrl({
                    url: 'pages/DiseaseManagePage',
                    params: { templateId: template.id }
                  });
                }
              )
            })
          }
          .width('100%')
          .padding(16)

          // ç”¨è¯ç®¡ç†åŒºåŸŸ
          Column({ space: 12 }) {
            Text('ç”¨è¯ç®¡ç†')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .alignSelf(ItemAlign.Start)

            this.ManageCard(
              'ç”¨è¯æé†’',
              'ç®¡ç†æ—¥å¸¸ç”¨è¯ä¸æé†’',
              '#FF9800',
              this.medicineCount,
              () => {
                router.pushUrl({ url: 'pages/MedicineManagePage' });
              }
            )
          }
          .width('100%')
          .padding(16)
        }
      }
      .layoutWeight(1)
      .backgroundColor('#F5F5F5')
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  ManageCard(
    title: string,
    subtitle: string,
    color: string,
    count: number,
    onClick: () => void
  ) {
    Column() {
      Row({ space: 12 }) {
        // å›¾æ ‡åŒºåŸŸ - æ¸å˜èƒŒæ™¯
        Row() {
          Text(title.charAt(0))
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FFFFFF')
        }
        .width(56)
        .height(56)
        .borderRadius(16)
        .linearGradient({
          angle: 135,
          colors: [[color, 0.0], [this.darkenColor(color), 1.0]]
        })
        .justifyContent(FlexAlign.Center)
        .shadow({
          radius: 8,
          color: `${color}40`,
          offsetY: 2
        })

        // å†…å®¹åŒºåŸŸ
        Column({ space: 4 }) {
          Text(title)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#212121')
          
          Text(subtitle)
            .fontSize(13)
            .fontColor('#757575')
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        // ç»Ÿè®¡åŒºåŸŸ
        Column({ space: 4 }) {
          Text(`${count}`)
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor(color)
          
          Text('æ¡è®°å½•')
            .fontSize(11)
            .fontColor('#9E9E9E')
        }
        .padding({ left: 12, right: 4 })
      }
      .width('100%')
      .padding(16)
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
    .shadow({
      radius: 12,
      color: '#15000000',
      offsetY: 4
    })
    .scale({
      x: this.cardScales.get(title) || 1,
      y: this.cardScales.get(title) || 1
    })
    .animation({
      duration: 200,
      curve: Curve.EaseInOut
    })
    .onTouch((event) => {
      if (event.type === TouchType.Down) {
        this.cardScales.set(title, 0.97);
        this.cardScales = new Map(this.cardScales);
      } else if (event.type === TouchType.Up || event.type === TouchType.Cancel) {
        this.cardScales.set(title, 1);
        this.cardScales = new Map(this.cardScales);
      }
    })
    .onClick(onClick)
  }

  // é¢œè‰²åŠ æ·±è¾…åŠ©æ–¹æ³•
  darkenColor(color: string): string {
    // ç®€å•çš„é¢œè‰²åŠ æ·±å¤„ç†
    const colors: Record<string, string> = {
      '#4CAF50': '#2E7D32',
      '#2196F3': '#1565C0',
      '#FF9800': '#E65100',
      '#F44336': '#C62828',
      '#9C27B0': '#6A1B9A'
    };
    return colors[color] || color;
  }
}