/**
 * å…³äºé¡µé¢
 * æ˜¾ç¤ºåº”ç”¨ä¿¡æ¯ã€ç‰ˆæœ¬ã€åé¦ˆè”ç³»æ–¹å¼ç­‰
 */

import router from '@ohos.router';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { promptAction } from '@kit.ArkUI';
import { DebugTools } from '../../utils/DebugTools';

const TAG = 'AboutPage';
const DOMAIN = 0x0000;

@Entry
@Component
export struct AboutPage {
  @State showDebugDialog: boolean = false;
  @State dbStats: Record<string, number> = {};
  @State debugPressCount: number = 0;
  @State debugMessage: string = '';

  build() {
    Column() {
      // å¯¼èˆªæ 
      Row() {
        Image($r('sys.media.ohos_ic_public_arrow_left'))
          .width(24)
          .height(24)
          .onClick(() => {
            router.back();
          })

        Text('å…³äº')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        Row()
          .width(24)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFFFFF')

      Scroll() {
        Column({ space: 24 }) {
          // åº”ç”¨ä¿¡æ¯å¡ç‰‡
          Column({ space: 16 }) {
            // åº”ç”¨å›¾æ ‡å’Œåç§°
            Column({ space: 12 }) {
              Row() {
                Column() {
                  Image($r('app.media.startIcon'))
                    .width(80)
                    .height(80)
                    .borderRadius(20)
                }
                .width(80)
              }
              .width('100%')
              .justifyContent(FlexAlign.Center)

              Text('æ…¢æ€§ç—…åŠ©æ‰‹')
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor('#212121')
                .textAlign(TextAlign.Center)
                .width('100%')
            }
            .width('100%')
            .alignItems(HorizontalAlign.Center)

            Divider()
              .strokeWidth(1)
              .color('#EEEEEE')
              .margin({ top: 8, bottom: 8 })

            // ç‰ˆæœ¬ä¿¡æ¯ï¼ˆé•¿æŒ‰æ¿€æ´»è°ƒè¯•ï¼‰
            Row() {
              Column({ space: 4 }) {
                Text('ç‰ˆæœ¬')
                  .fontSize(14)
                  .fontColor('#757575')

                Text('v1.0.0')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#212121')
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)
            }
            .width('100%')
            .padding({ left: 12, right: 12, top: 12, bottom: 12 })
            .gesture(
              LongPressGesture({ repeat: true, duration: 500 })
                .onAction(() => {
                  this.debugPressCount++;
                  if (this.debugPressCount >= 3) {
                    this.showDebugPanel();
                    this.debugPressCount = 0;
                  }
                })
            )

            // åº”ç”¨æè¿°
            Row() {
              Column({ space: 4 }) {
                Text('æè¿°')
                  .fontSize(14)
                  .fontColor('#757575')

                Text('æ™ºèƒ½å¥åº·ç®¡ç†ä¸“å®¶')
                  .fontSize(14)
                  .fontColor('#424242')

                Text('å¸®åŠ©æ‚¨æ›´å¥½åœ°ç®¡ç†æ…¢æ€§ç—…')
                  .fontSize(14)
                  .fontColor('#424242')

              }
              .alignItems(HorizontalAlign.Start)
              .width('100%')
              .layoutWeight(1)
            }
            .width('100%')
            .padding({ left: 12, right: 12, top: 12, bottom: 12 })
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#FFFFFF')
          .borderRadius(16)
          .margin({ left: 16, right: 16, top: 0 })

          // åé¦ˆä¿¡æ¯å¡ç‰‡
          Column({ space: 12 }) {
            Text('é—®é¢˜åé¦ˆ')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#212121')
              .width('100%')

            // é‚®ç®±
            Row() {
              Column({ space: 4 }) {
                Text('é‚®ç®±')
                  .fontSize(14)
                  .fontColor('#757575')

                Text('1446418561@qq.com')
                  .fontSize(15)
                  .fontColor($r('app.color.primary'))
                  .fontWeight(FontWeight.Medium)
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)

              // Image($r('sys.media.ohos_ic_public_arrow_right'))
              //   .width(20)
              //   .height(20)
              //   .fillColor('#BDBDBD')
            }
            .width('100%')
            .padding({ left: 12, right: 12, top: 12, bottom: 12 })
            .backgroundColor('#F5F5F5')
            .borderRadius(12)
            .onClick(() => {
              promptAction.showToast({ message: 'é‚®ç®±å·²å¤åˆ¶åˆ°å‰ªè´´æ¿' });
              hilog.info(DOMAIN, TAG, 'Feedback email clicked');
            })
          }
          .width('100%')
          .padding({ left: 16, right: 16, bottom: 16 })

          // å…¶ä»–ä¿¡æ¯
          Column({ space: 12 }) {
            Text('å…¶ä»–')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#212121')
              .width('100%')

            // ç”¨æˆ·åè®®
            Row() {
              Text('ç”¨æˆ·åè®®')
                .fontSize(15)
                .fontColor('#212121')
                .layoutWeight(1)

              Image($r('sys.media.ohos_ic_public_arrow_right'))
                .width(20)
                .height(20)
                .fillColor('#BDBDBD')
            }
            .width('100%')
            .padding({ left: 12, right: 12, top: 12, bottom: 12 })
            .backgroundColor('#FFFFFF')
            .borderRadius(12)

            // éšç§æ”¿ç­–
            Row() {
              Text('éšç§æ”¿ç­–')
                .fontSize(15)
                .fontColor('#212121')
                .layoutWeight(1)

              Image($r('sys.media.ohos_ic_public_arrow_right'))
                .width(20)
                .height(20)
                .fillColor('#BDBDBD')
            }
            .width('100%')
            .padding({ left: 12, right: 12, top: 12, bottom: 12 })
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
          }
          .width('100%')
          .padding({ left: 16, right: 16, bottom: 40 })
        }
        .width('100%')
        .constraintSize({ minHeight: '100%' })
      }
      .layoutWeight(1)
      .backgroundColor('#F5F5F5')
    }
    .width('100%')
    .height('100%')
  }

  async showDebugPanel() {
    this.showDebugDialog = true;
    // è·å–ç»Ÿè®¡ä¿¡æ¯
    try {
      this.dbStats = await DebugTools.getInstance().getDatabaseStats(getContext(this));
      this.debugMessage = `æ•°æ®åº“ç»Ÿè®¡:\n` +
        `å¥åº·è®°å½•: ${this.dbStats['health_records'] || 0}\n` +
        `æ¿€æ´»ç–¾ç—…: ${this.dbStats['active_disease_templates'] || 0}\n` +
        `è¯å“æ•°æ®: ${this.dbStats['medicine_data'] || 0}\n` +
        `ç”¨è¯è®°å½•: ${this.dbStats['medicine_records'] || 0}`;
      hilog.info(DOMAIN, TAG, 'Debug stats retrieved');
    } catch (err) {
      this.debugMessage = 'è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥';
      hilog.error(DOMAIN, TAG, 'Failed to get stats: %{public}s', JSON.stringify(err));
    }

    // å¼¹çª—æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
    AlertDialog.show({
      title: 'ğŸ”§ è°ƒè¯•å·¥å…·',
      message: this.debugMessage,
      primaryButton: {
        value: 'é‡ç½®RDB',
        action: async () => {
          try {
            await DebugTools.getInstance().resetRdbDatabase(getContext(this));
            promptAction.showToast({ message: 'RDBå·²é‡ç½®' });
          } catch (err) {
            promptAction.showToast({ message: 'é‡ç½®å¤±è´¥' });
          }
        }
      },
      secondaryButton: {
        value: 'é‡ç½®å…¨éƒ¨',
        action: async () => {
          try {
            await DebugTools.getInstance().resetAllData(getContext(this));
            promptAction.showToast({ message: 'æ‰€æœ‰æ•°æ®å·²é‡ç½®' });
          } catch (err) {
            promptAction.showToast({ message: 'é‡ç½®å¤±è´¥' });
          }
        }
      }
    });
  }
}
