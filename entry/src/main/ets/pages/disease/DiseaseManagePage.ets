/**
 * é€šç”¨ç–¾ç—…ç®¡ç†é¡µé¢
 * æ ¹æ®æ¨¡æ¿IDåŠ¨æ€åŠ è½½å¯¹åº”çš„ç–¾ç—…æ•°æ®
 */

import router from '@ohos.router';
import { promptAction } from '@kit.ArkUI';
import { HealthDataManager } from '../../utils/HealthDataManager';
import {
  DiseaseTemplate,
  IndicatorGroup,
  HealthRecord,
  IndicatorDefinition,
  IndicatorOption
} from '../../models/DiseaseTemplate';
import { BuiltInTemplates } from '../../config/BuiltInTemplates';

@Entry
@Component
struct DiseaseManagePage {
  @State template: DiseaseTemplate | null = null;
  @State records: HealthRecord[] = [];
  @State currentGroupIndex: number = 0;

  async aboutToAppear() {
    const params = router.getParams() as Record<string, Object>;
    const templateId = params['templateId'] as string;

    this.template = BuiltInTemplates.getTemplateById(templateId) || null;
    if (this.template) {
      await this.loadData();
    }
  }

  onPageShow() {
    if (this.template) {
      this.loadData();
    }
  }

  async loadData() {
    if (!this.template) {
      return;
    }

    const currentGroup = this.template.indicatorGroups[this.currentGroupIndex];
    if (currentGroup) {
      this.records = await HealthDataManager.getInstance().getHealthRecords(
        this.template.id,
        currentGroup.id
      );
    }
  }

  build() {
    Column() {
      // å¯¼èˆªæ 
      Row() {
        Image($r('sys.media.ohos_ic_public_arrow_left'))
          .width(24)
          .height(24)
          .onClick(() => {
            router.back();
          })

        Text(this.template?.name || 'ç–¾ç—…ç®¡ç†')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
          .margin({ right: 24 })
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFFFFF')

      // æŒ‡æ ‡ç»„åˆ‡æ¢ï¼ˆå¦‚æœæœ‰å¤šä¸ªç»„ï¼‰
      if (this.template && this.template.indicatorGroups.length > 1) {
        Tabs({ barPosition: BarPosition.Start, index: this.currentGroupIndex }) {
          ForEach(this.template.indicatorGroups, (group: IndicatorGroup) => {
            TabContent() {
              this.RecordListView(group);
            }
            .tabBar(group.name)
          })
        }
        .barMode(BarMode.Fixed)
        .layoutWeight(1)
        .onChange((index: number) => {
          this.currentGroupIndex = index;
          this.loadData();
        })
      } else if (this.template && this.template.indicatorGroups.length === 1) {
        this.RecordListView(this.template.indicatorGroups[0]);
      }

      // åº•éƒ¨å½•å…¥æŒ‰é’®
      if (this.template) {
        this.BottomButtons();
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  RecordListView(group: IndicatorGroup) {
    if (this.records.length === 0) {
      Column() {
        Text('ğŸ“‹')
          .fontSize(80)
          .margin({ top: 100 })

        Text('æš‚æ— æ•°æ®')
          .fontSize(16)
          .fontColor('#9E9E9E')
          .margin({ top: 16 })

        Text(`ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å½•å…¥${group.name}`)
          .fontSize(14)
          .fontColor('#BDBDBD')
          .margin({ top: 8 })
      }
      .width('100%')
      .height('100%')
    } else {
      List({ space: 12 }) {
        ForEach(this.records, (record: HealthRecord) => {
          ListItem() {
            this.RecordCard(record, group);
          }
        })
      }
      .width('100%')
      .height('100%')
      .padding(16)
      .backgroundColor('#F5F5F5')
    }
  }

  @Builder
  RecordCard(record: HealthRecord, group: IndicatorGroup) {
    Column({ space: 8 }) {
      // æ—¥æœŸå’Œç±»å‹
      Row() {
        Text(new Date(record.date).toLocaleDateString('zh-CN'))
          .fontSize(14)
          .fontColor('#1F1F1F')
          .fontWeight(FontWeight.Medium)

        Text(group.name)
          .fontSize(12)
          .fontColor('#FFFFFF')
          .padding({
            left: 8,
            right: 8,
            top: 2,
            bottom: 2
          })
          .backgroundColor(this.template?.color || '#4CAF50')
          .borderRadius(4)
          .margin({ left: 8 })

        Blank()

        Text('Ã—')
          .fontSize(24)
          .fontColor('#F44336')
          .fontWeight(FontWeight.Bold)
          .onClick(async () => {
            if (this.template) {
              await HealthDataManager.getInstance().deleteHealthRecord(this.template.id, record.id);
              await this.loadData();
              promptAction.showToast({ message: 'åˆ é™¤æˆåŠŸ' });
            }
          })
      }
      .width('100%')

      // æŒ‡æ ‡æ•°æ®å±•ç¤º
      this.buildIndicatorList(record, group);

      if (record.note) {
        Text(`å¤‡æ³¨ï¼š${record.note}`)
          .fontSize(12)
          .fontColor('#757575')
          .width('100%')
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
  }

  @Builder
  buildIndicatorList(record: HealthRecord, group: IndicatorGroup) {
    Column({ space: 6 }) {
      ForEach(group.indicators, (indicator: IndicatorDefinition) => {
        this.buildIndicatorRow(record, indicator);
      })
    }
    .width('100%')
  }

  @Builder
  buildIndicatorRow(record: HealthRecord, indicator: IndicatorDefinition) {
    Row() {
      Text(indicator.name)
        .fontSize(14)
        .fontColor('#424242')
        .width(100)

      this.buildIndicatorValue(record, indicator);
    }
    .width('100%')
  }

  @Builder
  buildIndicatorValue(record: HealthRecord, indicator: IndicatorDefinition) {
    if (indicator.type === 'select' && indicator.options) {
      this.buildSelectValue(record, indicator);
    } else {
      this.buildNumberValue(record, indicator);
    }
  }

  @Builder
  buildSelectValue(record: HealthRecord, indicator: IndicatorDefinition) {
    Text(this.getSelectLabel(record, indicator))
      .fontSize(16)
      .fontWeight(FontWeight.Medium)
      .fontColor('#424242')
      .layoutWeight(1)
  }

  @Builder
  buildNumberValue(record: HealthRecord, indicator: IndicatorDefinition) {
    Text(this.getIndicatorValueText(record, indicator))
      .fontSize(16)
      .fontWeight(FontWeight.Medium)
      .fontColor(this.getIndicatorValueColor(record, indicator))
      .layoutWeight(1)

    if (indicator.unit) {
      Text(indicator.unit)
        .fontSize(12)
        .fontColor('#9E9E9E')
        .width(60)
    }

    if (indicator.referenceMin !== undefined && indicator.referenceMax !== undefined) {
      Text(`(${indicator.referenceMin}-${indicator.referenceMax})`)
        .fontSize(12)
        .fontColor('#9E9E9E')
    }
  }

  getSelectLabel(record: HealthRecord, indicator: IndicatorDefinition): string {
    const value = record.getIndicator(indicator.id);
    if (value === undefined || !indicator.options) {
      return '';
    }
    const option = indicator.options.find((opt: IndicatorOption) => opt.value === value);
    return option?.label || (value as string);
  }

  getIndicatorValueText(record: HealthRecord, indicator: IndicatorDefinition): string {
    const value = record.getIndicator(indicator.id);
    return value !== undefined ? `${value}` : '';
  }

  getIndicatorValueColor(record: HealthRecord, indicator: IndicatorDefinition): string {
    const value = record.getIndicator(indicator.id);
    if (value === undefined || typeof value !== 'number') {
      return '#424242';
    }
    return this.getIndicatorColor(indicator, value);
  }

  @Builder
  BottomButtons() {
    if (this.template && this.template.indicatorGroups.length === 1) {
      this.SingleButton();
    } else if (this.template && this.template.indicatorGroups.length > 1) {
      this.MultipleButtons();
    }
  }

  @Builder
  SingleButton() {
    if (!this.template) {
      // Builderæ–¹æ³•ä¸èƒ½è¿”å›nullï¼Œä½¿ç”¨ç©ºç»„ä»¶ä»£æ›¿
      Blank();
    } else {
      Row() {
        Button(`å½•å…¥${this.template!.indicatorGroups[0].name}`)
          .width('100%')
          .backgroundColor(this.template!.color)
          .onClick(() => {
            router.pushUrl({
              url: 'pages/common/DataEntryPage',
              params: {
                templateId: this.template?.id,
                groupId: this.template!.indicatorGroups[0].id
              }
            });
          })
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FFFFFF')
    }
  }

  @Builder
  MultipleButtons() {
    Row({ space: 12 }) {
      ForEach(this.template?.indicatorGroups, (group: IndicatorGroup, index: number) => {
        Button(`å½•å…¥${group.name}`)
          .layoutWeight(1)
          .backgroundColor(this.template?.color)
          .opacity(index === 0 ? 1 : 0.8)
          .onClick(() => {
            router.pushUrl({
              url: 'pages/common/DataEntryPage',
              params: {
                templateId: this.template?.id,
                groupId: group.id
              }
            });
          })
      })
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
  }

  getIndicatorColor(indicator: IndicatorDefinition, value: number): string {
    if (!indicator.warningLevels) {
      return '#424242';
    }

    for (const level of indicator.warningLevels) {
      const minOk = level.min === undefined || value >= level.min;
      const maxOk = level.max === undefined || value <= level.max;

      if (minOk && maxOk) {
        switch (level.level) {
          case 'normal':
            return '#4CAF50';
          case 'warning':
            return '#FF9800';
          case 'danger':
            return '#F44336';
          default:
            return '#424242';
        }
      }
    }

    return '#F44336';
  }
}

