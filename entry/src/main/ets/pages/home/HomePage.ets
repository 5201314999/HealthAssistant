import router from '@ohos.router';
import { UserPreferenceManager } from '../../utils/DataPreference';
import { HealthRecordDatabase } from '../../utils/HealthRecordDatabase';
import { BuiltInTemplates } from '../../config/BuiltInTemplates';
import { DiseaseTemplate } from '../../models/DiseaseTemplate';
import { HealthRecord } from '../../models/DiseaseTemplate';
import { MedicineRecord } from '../../models/MedicineData';
interface BloodPressure {
  systolic: number;
  diastolic: number;
}
@Entry
@Component
export struct HomePage {
  @State currentTab: number = 0;
  @State diseaseCount: number = 0;
  @State latestBloodPressure: BloodPressure | null = null;
  @State latestGlucose: number | null = null;
  @State templates: DiseaseTemplate[] = [];
  @State templateCounts: Map<string, number> = new Map();
  @State todayMedicineRecords: MedicineRecord[] = [];
  @State activeTemplates: string[] = [];

  async aboutToAppear() {
    await this.loadData();
  }

  onPageShow() {
    // é¡µé¢æ˜¾ç¤ºæ—¶é‡æ–°åŠ è½½æ•°æ®ï¼Œç¡®ä¿è¿”å›é¦–é¡µæ—¶æ˜¾ç¤ºæœ€æ–°çš„ç–¾ç—…åˆ—è¡¨
    this.loadData();
  }

  async loadData() {
    const db = HealthRecordDatabase.getInstance();
    
    // åŠ è½½æ¨¡æ¿åˆ—è¡¨
    this.templates = BuiltInTemplates.getAllTemplates();
    
    // è·å–å·²æ¿€æ´»çš„ç–¾ç—…æ¨¡æ¿
    const activeTemplatesFromDB = await db.getActiveDiseaseTemplates();
    this.activeTemplates = activeTemplatesFromDB.map((t) => t.templateId);
    
    // åŠ è½½æ¯ä¸ªæ¨¡æ¿çš„è®°å½•æ•°
    for (const template of this.templates) {
      const count = await db.getRecordCount(template.id);
      this.templateCounts.set(template.id, count);
    }
    console.log('this.activeTemplates=======:', this.activeTemplates)
    
    // è®¡ç®—ç–¾ç—…æ•°é‡
    this.diseaseCount = this.activeTemplates.length;
    
    // åŠ è½½æœ€æ–°è¡€å‹æ•°æ®
    const latestBP = await db.getLatestHealthRecord('hypertension', 'blood_pressure');
    if (latestBP) {
      const systolic = latestBP.getIndicator('systolic') as number;
      const diastolic = latestBP.getIndicator('diastolic') as number;
      this.latestBloodPressure = { systolic, diastolic };
    }
    
    // åŠ è½½æœ€æ–°è¡€ç³–æ•°æ®
    const latestDiabetes = await db.getLatestHealthRecord('diabetes', 'glucose');
    if (latestDiabetes) {
      this.latestGlucose = latestDiabetes.getIndicator('glucose') as number;
    }
    
    // åŠ è½½ä»Šæ—¥ç”¨è¯è®°å½•
    this.todayMedicineRecords = await db.getMedicineRecords(Date.now() - 24 * 60 * 60 * 1000, Date.now());
    
    // è§¦å‘UIæ›´æ–°
    this.templateCounts = new Map(this.templateCounts);
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ
      Column() {
        Row() {
          // Logo
          Row() {
            // Image($r('app.media.heart'))
            //   .width(32)
            //   .height(32)
            //   .fillColor('#FFFFFF')
            // SymbolGlyph({ symbol: $r('app.media.heart') })
            //   .fontSize(24)
            //   .fontWeight(600)
            //   .renderMode(SymbolRenderMode.SINGLE)
            //   .foregroundColor(Color.Blue)
          }
          .width(60)
          .height(60)
          .borderRadius(30)
          .backgroundColor($r('app.color.primary'))
          .justifyContent(FlexAlign.Center)
          .margin({ right: 16 })

          Column({ space: 4 }) {
            Text('æ…¢æ€§ç—…åŠ©æ‰‹')
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#212121')

            Text('æ™ºèƒ½å¥åº·ç®¡ç†ä¸“å®¶')
              .fontSize(13)
              .fontColor('#757575')
          }
          .alignItems(HorizontalAlign.Start)
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 20, bottom: 16 })
      }
      .width('100%')
      .backgroundColor('#FFFFFF')

      // Tabåˆ‡æ¢æŒ‰é’®
      Row({ space: 12 }) {
        Button(this.currentTab === 0 ? 'å¥åº·æ¦‚è§ˆ' : 'å¥åº·æ¦‚è§ˆ')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.currentTab === 0 ? '#FFFFFF' : '#757575')
          .backgroundColor(this.currentTab === 0 ? $r('app.color.primary') : '#F5F5F5')
          .layoutWeight(1)
          .height(48)
          .borderRadius(24)
          .onClick(() => {
            this.currentTab = 0;
          })

        Button(this.currentTab === 1 ? 'ä»Šæ—¥ç”¨è¯' : 'ä»Šæ—¥ç”¨è¯')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.currentTab === 1 ? '#FFFFFF' : '#757575')
          .backgroundColor(this.currentTab === 1 ? $r('app.color.primary') : '#F5F5F5')
          .layoutWeight(1)
          .height(48)
          .borderRadius(24)
          .onClick(() => {
            this.currentTab = 1;
          })
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 8, bottom: 8 })
      .backgroundColor('#FFFFFF')

      // å†…å®¹åŒºåŸŸ
      if (this.currentTab === 0) {
        this.HealthOverviewContent()
      } else {
        this.TodayMedicineContent()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#ffffff')
  }

  @Builder
  HealthOverviewContent() {
    Scroll() {
      Column({ space: 16 }) {
        // å¥åº·çŠ¶æ€æ¦‚è§ˆå¡ç‰‡
        Column({ space: 16 }) {
          Column({ space: 4 }) {
            Text('å¥åº·çŠ¶æ€æ¦‚è§ˆ')
              .textAlign(TextAlign.Center)
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#212121')
              .width('100%')
              .margin({ bottom: 8 })
            Text(`æ­£åœ¨ç®¡ç† ${this.diseaseCount} ç§æ…¢æ€§ç—…`)
              .fontSize(14)
              .fontColor('#757575')
              .width('100%')
              .textAlign(TextAlign.Center)
          }
          .width('100%')

          // å¥åº·æ•°æ®å±•ç¤º
          Row({ space: 12 }) {
            // æ”¶ç¼©å‹
            Column({ space: 4 }) {
              Text('æ”¶ç¼©å‹')
                .fontSize(13)
                .fontColor('#757575')

              Text(this.latestBloodPressure ? `${this.latestBloodPressure.systolic}` : '--')
                .fontSize(32)
                .fontWeight(FontWeight.Bold)
                .fontColor('#212121')

              Text('mmHg')
                .fontSize(12)
                .fontColor('#9E9E9E')
            }
            .layoutWeight(1)
            .padding(16)
            .backgroundColor('#FAFAFA')
            .borderRadius(12)

            // èˆ’å¼ å‹
            Column({ space: 4 }) {
              Text('èˆ’å¼ å‹')
                .fontSize(13)
                .fontColor('#757575')

              Text(this.latestBloodPressure ? `${this.latestBloodPressure.diastolic}` : '--')
                .fontSize(32)
                .fontWeight(FontWeight.Bold)
                .fontColor('#212121')

              Text('mmHg')
                .fontSize(12)
                .fontColor('#9E9E9E')
            }
            .layoutWeight(1)
            .padding(16)
            .backgroundColor('#FAFAFA')
            .borderRadius(12)

            // è¡€ç³–
            Column({ space: 4 }) {
              Text('è¡€ç³–')
                .fontSize(13)
                .fontColor('#757575')

              Text(this.latestGlucose ? `${this.latestGlucose.toFixed(1)}` : '--')
                .fontSize(32)
                .fontWeight(FontWeight.Bold)
                .fontColor('#212121')

              Text('mmol/L')
                .fontSize(12)
                .fontColor('#9E9E9E')
            }
            .layoutWeight(1)
            .padding(16)
            .backgroundColor('#FAFAFA')
            .borderRadius(12)
          }
          .width('100%')

          // æŸ¥çœ‹å†å²å°±è¯Šè®°å½•æŒ‰é’®
          Button({ type: ButtonType.Normal }) {
            Row({ space: 6 }) {
              Image($r('app.media.trending_up'))
                .width(20)
                .height(20)
                .fillColor($r('app.color.primary'))

              Text('æŸ¥çœ‹å†å²å°±è¯Šè®°å½•')
                .fontSize(14)
                .fontColor($r('app.color.primary'))
            }
          }
          .width('100%')
          .height(44)
          .backgroundColor('#F0F7FF')
          .borderRadius(8)
          .onClick(() => {
            router.pushUrl({
              url: 'pages/medical/MedicalRecordsPage'
            });
          })
        }
        .padding(20)
        .backgroundColor('#eff6ff')
        .borderRadius(16)
        .margin({ left: 16, right: 16, top: 12 })

        // æ·»åŠ ç–¾ç—…å’Œå°±è¯Šè®°å½•æŒ‰é’®
        Row({ space: 12 }) {
          // æ·»åŠ ç–¾ç—…æŒ‰é’®
          Button() {
            Column({ space: 8 }) {
              Image($r('app.media.plus'))
                .width(24)
                .height(24)
                .fillColor('#4CAF50')

              Text('æ·»åŠ ç–¾ç—…')
                .fontSize(14)
                .fontColor('#212121')
            }
            .alignItems(HorizontalAlign.Center)
          }
          .height(100)
          .layoutWeight(1)
          .backgroundColor('#F5F5F5')
          .borderRadius(6)
          .onClick(() => {
            router.pushUrl({
              url: 'pages/disease/AddDiseasePage'
            });
          })

          // æ·»åŠ å°±è¯Šè®°å½•æŒ‰é’®
          Button() {
            Column({ space: 8 }) {
              Image($r('app.media.calendar'))
                .width(24)
                .height(24)
                .fillColor('#2196F3')

              Text('æ·»åŠ å°±è¯Šè®°å½•')
                .fontSize(14)
                .fontColor('#212121')
            }
            .alignItems(HorizontalAlign.Center)
          }
          .height(100)
          .layoutWeight(1)
          .backgroundColor('#F5F5F5')
          .borderRadius(6)
          .onClick(() => {
            router.pushUrl({
              url: 'pages/medical/AddMedicalRecordPage'
            });
          })
        }
        .width('100%')
        .padding({
          left: 16,
          right: 16,
          top: 8,
          bottom: 8
        })

        // ç–¾ç—…åˆ—è¡¨
        Column({ space: 12 }) {
          ForEach(this.templates, (template: DiseaseTemplate) => {
            // æ˜¾ç¤ºå·²æ¿€æ´»çš„ç–¾ç—…æ¨¡æ¿ï¼Œæ— è®ºæ˜¯å¦æœ‰è®°å½•
            if (this.activeTemplates.includes(template.id)) {
              this.DiseaseCard(template, this.templateCounts.get(template.id) || 0);
            }
          })
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 16 })
      }
      .width('100%')
      .constraintSize({ minHeight: '100%' })
    }
    .layoutWeight(1)
  }

  @Builder
  TodayMedicineContent() {
    if (this.todayMedicineRecords.length === 0) {
      Column() {
        Text('ğŸ’Š')
          .fontSize(80)
          .margin({ top: 100 })

        Text('ä»Šæ—¥æš‚æ— ç”¨è¯è®°å½•')
          .fontSize(16)
          .fontColor('#9E9E9E')
          .margin({ top: 16 })

        Text('æ·»åŠ è¯å“åä¼šè‡ªåŠ¨ç”Ÿæˆç”¨è¯è®°å½•')
          .fontSize(14)
          .fontColor('#BDBDBD')
          .margin({ top: 8 })
      }
      .width('100%')
      .layoutWeight(1)
    } else {
      Scroll() {
        Column({ space: 12 }) {
          // ä»Šæ—¥è¿›åº¦å¡ç‰‡
          Column({ space: 12 }) {
            Row() {
              Text('ä»Šæ—¥è¿›åº¦')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor('#757575')
                .layoutWeight(1)

              Text(`${this.getTakenCount()}/${this.todayMedicineRecords.length}`)
                .fontSize(14)
                .fontColor('#4CAF50')
            }
            .width('100%')

            Progress({
              value: this.getTakenCount(),
              total: this.todayMedicineRecords.length,
              type: ProgressType.Linear
            })
            .width('100%')
            .color('#4CAF50')
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .margin({ left: 16, right: 16, top: 12 })

          // ç”¨è¯è®°å½•åˆ—è¡¨
          Column({ space: 8 }) {
            ForEach(this.todayMedicineRecords, (record: MedicineRecord) => {
              this.MedicineRecordCard(record);
            })
          }
          .width('100%')
          .padding({ left: 16, right: 16, bottom: 16 })
        }
        .width('100%')
      }
      .layoutWeight(1)
    }
  }

  @Builder
  DiseaseCard(template: DiseaseTemplate, count: number) {
    Row() {
      // å›¾æ ‡
      Row() {
        Text(template.name.charAt(0))
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
      }
      .width(48)
      .height(48)
      .borderRadius(24)
      .backgroundColor(template.color)
      .justifyContent(FlexAlign.Center)
      .margin({ right: 12 })

      // ä¿¡æ¯
      Column({ space: 4 }) {
        Text(template.name)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#212121')

        Text(`å·²è®°å½• ${count} æ¬¡`)
          .fontSize(13)
          .fontColor('#9E9E9E')
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // æ—¥æœŸ
      Text(this.getLatestDateSync(template.id))
        .fontSize(12)
        .fontColor('#BDBDBD')
        .margin({ right: 8 })

      Image($r('sys.media.ohos_ic_public_arrow_right'))
        .width(20)
        .height(20)
        .fillColor('#BDBDBD')
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .onClick(() => {
      router.pushUrl({
        url: 'pages/disease/DiseaseManagePage',
        params: { templateId: template.id }
      });
    })
  }

  @Builder
  MedicineRecordCard(record: MedicineRecord) {
    Row() {
      Checkbox()
        .select(record.taken)
        .onChange(async (value: boolean) => {
          record.taken = value;
          record.takenTime = value ? Date.now() : 0;
          await HealthRecordDatabase.getInstance().saveMedicineRecord(record);
          await this.loadData();
        })
        .margin({ right: 12 })

      Column({ space: 4 }) {
        Text(record.medicineName)
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .fontColor('#212121')
          .decoration({ type: record.taken ? TextDecorationType.LineThrough : TextDecorationType.None })

        Text(this.getTimeName(record.time))
          .fontSize(12)
          .fontColor('#757575')
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      if (record.taken) {
        Image($r('sys.media.ohos_ic_public_ok'))
          .width(24)
          .height(24)
          .fillColor('#4CAF50')
      }
    }
    .width('100%')
    .padding(12)
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
  }

  getTimeName(time: string): string {
    switch (time) {
      case 'morning':
        return 'æ—©ä¸Š';
      case 'noon':
        return 'ä¸­åˆ';
      case 'evening':
        return 'æ™šä¸Š';
      case 'bedtime':
        return 'ç¡å‰';
      default:
        return time;
    }
  }

  getTakenCount(): number {
    return this.todayMedicineRecords.filter(r => r.taken).length;
  }

  getLatestDateSync(templateId: string): string {
    // åŒæ­¥æ–¹æ³•ï¼Œè¿”å›é»˜è®¤å€¼
    return '--';
  }

  async getLatestDate(templateId: string): Promise<string> {
    try {
      const latestRecord = await HealthRecordDatabase.getInstance().getLatestHealthRecord(templateId);
      if (latestRecord) {
        const date = new Date(latestRecord.date);
        return `${date.getMonth() + 1}/${date.getDate()}`;
      }
      return '--';
    } catch (err) {
      return '--';
    }
  }
}

