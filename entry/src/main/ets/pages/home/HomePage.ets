import router from '@ohos.router';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { HealthRecordDatabase } from '../../utils/HealthRecordDatabase';
import { BuiltInTemplates } from '../../config/BuiltInTemplates';
import { DiseaseTemplate } from '../../models/DiseaseTemplate';
import { MedicineRecord } from '../../models/MedicineData';

const TAG = 'HomePage';
const DOMAIN = 0x0000;

interface BloodPressure {
  systolic: number;
  diastolic: number;
}

interface IndicatorItem {
  name: string;
  value: string | number;
  unit?: string;
}

interface HealthIndicator {
  diseaseId: string;
  diseaseName: string;
  diseaseColor: string;
  indicators: IndicatorItem[];
}

@Entry
@Component
export struct HomePage {
  @State currentTab: number = 0;
  @State diseaseCount: number = 0;
  @State latestBloodPressure: BloodPressure | null = null;
  @State latestGlucose: number | null = null;
  @State templates: DiseaseTemplate[] = [];
  @State templateCounts: Map<string, number> = new Map();
  @State todayMedicineRecords: MedicineRecord[] = [];
  @State activeTemplates: string[] = [];
  @State healthIndicators: HealthIndicator[] = []; // Swiper æ•°æ®æº
  private indicatorSwiperController: SwiperController = new SwiperController(); // Swiper æ§åˆ¶å™¨
  @State diseaseIndicators: Map<string, IndicatorItem[]> = new Map(); // å­˜å‚¨æ¯ä¸ªç–¾ç—…çš„æ ¸å¿ƒæŒ‡æ ‡
  @State swiperIndex:number=0
  @Watch('onRefreshKeyChanged') @Prop refreshKey: number = 0; // åˆ·æ–°è§¦å‘å™¨

  async aboutToAppear() {
    console.log('HomePage aboutToAppear')
    await this.loadData();
    hilog.debug(DOMAIN, TAG, 'HomePage aboutToAppear');
  }

  // ç›‘å¬ refreshKey å˜åŒ–ï¼Œè§¦å‘åˆ·æ–°
  async onRefreshKeyChanged() {
    if (this.refreshKey > 0) {
      console.log('HomePage refreshKey changed, reloading data');
      await this.loadData();
    }
  }

  async loadData() {
    hilog.info(DOMAIN, TAG, 'LoadData start');
    const db = HealthRecordDatabase.getInstance();

    // åŠ è½½æ¨¡æ¿åˆ—è¡¨
    this.templates = BuiltInTemplates.getAllTemplates();
    hilog.info(DOMAIN, TAG, 'Loaded templates count:%{public}d', this.templates.length);

    // è·å–å·²æ¿€æ´»çš„ç–¾ç—…æ¨¡æ¿
    const activeTemplatesFromDB = await db.getActiveDiseaseTemplates();
    this.activeTemplates = activeTemplatesFromDB.map((t) => t.templateId);
    hilog.info(DOMAIN, TAG, 'Active templates count:%{public}d', this.activeTemplates.length);

    // è®¡ç®—ç–¾ç—…æ•°é‡ï¼ˆä»æ¿€æ´»çš„ç–¾ç—…æ¨¡æ¿è·å–ï¼‰
    this.diseaseCount = this.activeTemplates.length;
    console.log('this.diseaseCount:', this.diseaseCount)

    // åŠ è½½æ¯ä¸ªæ¨¡æ¿çš„è®°å½•æ•°å’Œæ ¸å¿ƒæŒ‡æ ‡
    this.diseaseIndicators.clear();
    for (const template of this.templates) {
      const count = await db.getRecordCount(template.id);
      this.templateCounts.set(template.id, count);

      // åŠ è½½è¯¥ç–¾ç—…çš„æ ¸å¿ƒæŒ‡æ ‡ï¼ˆæœ€å¤š3ä¸ªï¼‰
      await this.loadDiseaseIndicators(template, db);
    }

    // åŠ è½½ Swiper æ•°æ®ï¼šæ¯ä¸ªæ¿€æ´»ç–¾ç—…çš„æœ€è¿‘è¯Šç–—è®°å½•æŒ‡æ ‡
    await this.loadHealthIndicators(db);

    // åŠ è½½æœ€æ–°è¡€å‹æ•°æ®
    const latestBP = await db.getLatestHealthRecord('hypertension', 'blood_pressure');
    if (latestBP) {
      const systolic = latestBP.getIndicator('systolic') as number;
      const diastolic = latestBP.getIndicator('diastolic') as number;
      this.latestBloodPressure = { systolic, diastolic };
      hilog.debug(DOMAIN, TAG, 'Latest blood pressure - systolic:%{public}d, diastolic:%{public}d', systolic, diastolic);
    }

    // åŠ è½½æœ€æ–°è¡€ç³–æ•°æ®
    const latestDiabetes = await db.getLatestHealthRecord('diabetes', 'glucose');
    if (latestDiabetes) {
      this.latestGlucose = latestDiabetes.getIndicator('glucose') as number;
      hilog.debug(DOMAIN, TAG, 'Latest glucose:%{public}f', this.latestGlucose as number);
    }

    // åŠ è½½ä»Šæ—¥ç”¨è¯è®°å½•
    this.todayMedicineRecords = await db.getMedicineRecords(Date.now() - 24 * 60 * 60 * 1000, Date.now());
    hilog.info(DOMAIN, TAG, 'Today medicine records count:%{public}d', this.todayMedicineRecords.length);

    // è§¦å‘UIæ›´æ–°
    this.templateCounts = new Map(this.templateCounts);
    this.activeTemplates = [...this.activeTemplates];
    this.diseaseIndicators = new Map(this.diseaseIndicators);
    this.healthIndicators = [...this.healthIndicators];
    hilog.debug(DOMAIN, TAG, 'LoadData completed');
  }

  private async loadDiseaseIndicators(template: DiseaseTemplate, db: HealthRecordDatabase): Promise<void> {
    try {
      const indicators: IndicatorItem[] = [];

      // è·å–è¯¥ç–¾ç—…çš„ç¬¬ä¸€ç»„æŒ‡æ ‡å®šä¹‰ï¼ˆæœ€å¤šå‰3ä¸ªï¼‰
      if (template.indicatorGroups.length > 0) {
        const firstGroup = template.indicatorGroups[0];
        const indicatorDefs = firstGroup.indicators.slice(0, 3); // åªå–å‰3ä¸ªæŒ‡æ ‡

        // è·å–æ¯ä¸ªæŒ‡æ ‡çš„æœ€æ–°å€¼
        for (const indicatorDef of indicatorDefs) {
          try {
            const latestRecord = await db.getLatestHealthRecord(template.id, firstGroup.id);
            if (latestRecord) {
              const value = latestRecord.getIndicator(indicatorDef.id);
              if (value !== undefined) {
                indicators.push({
                  name: indicatorDef.name,
                  value: value,
                  unit: indicatorDef.unit
                });
                hilog.debug(DOMAIN, TAG, 'Loaded indicator: %{public}s=%{public}s', indicatorDef.name, String(value));
              }
            }
          } catch (err) {
            const error = err as Error;
            hilog.warn(DOMAIN, TAG, 'Failed to load indicator %{public}s: %{public}s', indicatorDef.name, error.message);
          }
        }
      }

      if (indicators.length > 0) {
        this.diseaseIndicators.set(template.id, indicators);
        hilog.info(DOMAIN, TAG, 'Loaded %{public}d indicators for disease: %{public}s', indicators.length, template.name);
      }
    } catch (err) {
      const error = err as Error;
      hilog.error(DOMAIN, TAG, 'Failed to load disease indicators for %{public}s: %{public}s', template.name, error.message);
    }
  }

  private async loadHealthIndicators(db: HealthRecordDatabase): Promise<void> {
    try {
      this.healthIndicators = [];

      // é»˜è®¤æŒ‡æ ‡IDæ˜ å°„
      const defaultIndicators: Record<string, string> = {
        'hypertension': 'systolic',  // é«˜è¡€å‹
        'diabetes': 'glucose'        // ç³–å°¿ç—…
      };

      // é»˜è®¤å•ä½
      const defaultUnits: Record<string, string> = {
        'systolic': 'mmHg',
        'diastolic': 'mmHg',
        'glucose': 'mmol/L'
      };

      // ä¸ºæ¯ä¸ªæ¿€æ´»çš„ç–¾ç—…åŠ è½½æœ€è¿‘çš„è¯Šç–—è®°å½•
      for (const templateId of this.activeTemplates) {
        const template = this.templates.find(t => t.id === templateId);
        if (!template) continue;

        try {
          // è·å–è¯¥ç–¾ç—…æœ€è¿‘çš„è¯Šç–—è®°å½•
          const latestRecord = await db.getLatestHealthRecord(templateId);
          if (!latestRecord) {
            hilog.warn(DOMAIN, TAG, 'No health record found for disease: %{public}s', templateId);
            continue;
          }

          // æå–æœ€å¤š3ä¸ªé»˜è®¤æŒ‡æ ‡
          const indicators: IndicatorItem[] = [];

          // å¯¹äºé«˜è¡€å‹ï¼Œæ˜¾ç¤ºæ”¶ç¼©å‹å’Œèˆ’å¼ å‹
          if (templateId === 'hypertension') {
            const systolic = latestRecord.getIndicator('systolic');
            const diastolic = latestRecord.getIndicator('diastolic');

            if (systolic !== undefined) {
              indicators.push({
                name: 'æ”¶ç¼©å‹',
                value: systolic,
                unit: defaultUnits['systolic']
              });
            }
            if (diastolic !== undefined) {
              indicators.push({
                name: 'èˆ’å¼ å‹',
                value: diastolic,
                unit: defaultUnits['diastolic']
              });
            }
          }
          // å¯¹äºç³–å°¿ç—…ï¼Œæ˜¾ç¤ºè¡€ç³–
          else if (templateId === 'diabetes') {
            const glucose = latestRecord.getIndicator('glucose');
            if (glucose !== undefined) {
              indicators.push({
                name: 'è¡€ç³–',
                value: glucose,
                unit: defaultUnits['glucose']
              });
            }
          }
          // å…¶ä»–ç–¾ç—…ï¼šä»ç¬¬ä¸€ç»„æŒ‡æ ‡ä¸­å–å‰3ä¸ª
          else {
            if (template.indicatorGroups.length > 0) {
              const firstGroup = template.indicatorGroups[0];
              for (const indicatorDef of firstGroup.indicators.slice(0, 3)) {
                const value = latestRecord.getIndicator(indicatorDef.id);
                if (value !== undefined) {
                  indicators.push({
                    name: indicatorDef.name,
                    value: value,
                    unit: indicatorDef.unit
                  });
                }
              }
            }
          }

          // å¦‚æœæœ‰æŒ‡æ ‡æ•°æ®ï¼Œæ·»åŠ åˆ°åˆ—è¡¨
          if (indicators.length > 0) {
            this.healthIndicators.push({
              diseaseId: templateId,
              diseaseName: template.name,
              diseaseColor: template.color,
              indicators: indicators
            });
            hilog.info(DOMAIN, TAG, 'Loaded health indicators for: %{public}s', template.name);
          }
        } catch (err) {
          const error = err as Error;
          hilog.warn(DOMAIN, TAG, 'Failed to load indicators for %{public}s: %{public}s', templateId, error.message);
        }
      }

      hilog.info(DOMAIN, TAG, 'Loaded %{public}d health indicator sets', this.healthIndicators.length);
    } catch (err) {
      const error = err as Error;
      hilog.error(DOMAIN, TAG, 'Failed to load health indicators: %{public}s', error.message);
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ
      Column() {
        Row() {
          // Logo
          Row() {
            // Image($r('app.media.heart'))
            //   .width(32)
            //   .height(32)
            //   .fillColor('#FFFFFF')
            // SymbolGlyph({ symbol: $r('app.media.heart') })
            //   .fontSize(24)
            //   .fontWeight(600)
            //   .renderMode(SymbolRenderMode.SINGLE)
            //   .foregroundColor(Color.Blue)
            Text('ó°€¡').fontSize(28).fontColor(Color.White)
          }
          .width(60)
          .height(60)
          .borderRadius(30)
          .backgroundColor($r('app.color.primary'))
          .justifyContent(FlexAlign.Center)
          .margin({ right: 16 })

          Column({ space: 4 }) {
            Text('æ…¢æ€§ç—…åŠ©æ‰‹')
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#212121')

            Text('æ™ºèƒ½å¥åº·ç®¡ç†ä¸“å®¶')
              .fontSize(13)
              .fontColor('#757575')
          }
          .alignItems(HorizontalAlign.Start)
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 20, bottom: 16 })
      }
      .width('100%')
      .backgroundColor('#FFFFFF')

      // Tabåˆ‡æ¢æŒ‰é’®
      Row({ space: 12 }) {
        Button(this.currentTab === 0 ? 'å¥åº·æ¦‚è§ˆ' : 'å¥åº·æ¦‚è§ˆ')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.currentTab === 0 ? '#FFFFFF' : '#757575')
          .backgroundColor(this.currentTab === 0 ? $r('app.color.primary') : '#F5F5F5')
          .layoutWeight(1)
          .height(48)
          .borderRadius(24)
          .onClick(() => {
            this.currentTab = 0;
          })

        Button(this.currentTab === 1 ? 'ä»Šæ—¥ç”¨è¯' : 'ä»Šæ—¥ç”¨è¯')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.currentTab === 1 ? '#FFFFFF' : '#757575')
          .backgroundColor(this.currentTab === 1 ? $r('app.color.primary') : '#F5F5F5')
          .layoutWeight(1)
          .height(48)
          .borderRadius(24)
          .onClick(() => {
            this.currentTab = 1;
          })
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 8, bottom: 8 })
      .backgroundColor('#FFFFFF')

      // å†…å®¹åŒºåŸŸ
      if (this.currentTab === 0) {
        this.HealthOverviewContent()
      } else {
        this.TodayMedicineContent()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#ffffff')
  }

  @Builder
  HealthOverviewContent() {
    Scroll() {
      Column({ space: 16 }) {
        // å¥åº·çŠ¶æ€æ¦‚è§ˆå¡ç‰‡
        Column({ space: 16 }) {
          Column({ space: 4 }) {
            Text('å¥åº·çŠ¶æ€æ¦‚è§ˆ')
              .textAlign(TextAlign.Center)
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#212121')
              .width('100%')
              .margin({ bottom: 8 })
            Text(`æ­£åœ¨ç®¡ç† ${this.diseaseCount} ç§æ…¢æ€§ç—…`)
              .fontSize(14)
              .fontColor('#757575')
              .width('100%')
              .textAlign(TextAlign.Center)
          }
          .width('100%')

          // Swiper å¥åº·æ•°æ®å±•ç¤º
          if (this.activeTemplates.length > 0) {
            Column() {
              Swiper(this.indicatorSwiperController) {
                ForEach(this.healthIndicators, (item: HealthIndicator) => {
                  this.HealthIndicatorCard(item);
                })
              }
              .index(0)
              .autoPlay(false)
              .duration(300)
              .curve(Curve.Linear)
              .onChange((index: number) => {
                this.swiperIndex=index
              })
              .height(160)
              .margin({ left: 16, right: 16 })

              // æŒ‡ç¤ºå™¨
              if (this.healthIndicators.length > 1) {
                Row({ space: 6 }) {
                  ForEach(this.healthIndicators, (_: HealthIndicator, index: number) => {
                    Circle()
                      .width(8)
                      .height(8)
                      .fill(index === this.swiperIndex ? $r('app.color.primary') : '#BDBDBD')
                  })
                }
                .width('100%')
                .justifyContent(FlexAlign.Center)
                .padding({ top: 12 })
              }
            }
            .width('100%')
          } else {
            Column() {
              Text('æš‚æ— å¥åº·æ•°æ®')
                .fontSize(14)
                .fontColor('#9E9E9E')
                .width('100%')
                .textAlign(TextAlign.Center)
            }
            .width('100%')
            .height(160)
            .justifyContent(FlexAlign.Center)
            .backgroundColor('#F5F5F5')
            .borderRadius(12)
            .margin({ left: 16, right: 16 })
          }

          // æŸ¥çœ‹å†å²å°±è¯Šè®°å½•æŒ‰é’®
          Button({ type: ButtonType.Normal }) {
            Row({ space: 6 }) {
              Image($r('app.media.trending_up'))
                .width(20)
                .height(20)
                .fillColor($r('app.color.primary'))

              Text('æŸ¥çœ‹å†å²å°±è¯Šè®°å½•')
                .fontSize(14)
                .fontColor($r('app.color.primary'))
            }
          }
          .width('100%')
          .height(44)
          .backgroundColor('#F0F7FF')
          .borderRadius(8)
          .onClick(() => {
            router.pushUrl({
              url: 'pages/medical/MedicalRecordsPage'
            });
          })
        }
        .padding(20)
        .backgroundColor('#eff6ff')
        .borderRadius(16)
        .margin({ left: 16, right: 16, top: 12 })

        // æ·»åŠ ç–¾ç—…å’Œå°±è¯Šè®°å½•æŒ‰é’®
        Row({ space: 12 }) {
          Button() {
            Column({ space: 8 }) {
              Image($r('app.media.plus'))
                .width(24)
                .height(24)
                .fillColor('#212121')

              Text('æ·»åŠ ç–¾ç—…')
                .fontSize(14)
                .fontColor('#212121')
            }
            .alignItems(HorizontalAlign.Center)
          }
          .height(100)
          .layoutWeight(1)
          .backgroundColor('#F5F5F5')
          .borderRadius(6)
          .onClick(() => {
            router.pushUrl({
              url: 'pages/disease/AddDiseasePage'
            });
          })

          Button() {
            Column({ space: 8 }) {
              Image($r('app.media.calendar'))
                .width(24)
                .height(24)
                .fillColor('#212121')

              Text('æ·»åŠ å°±è¯Šè®°å½•')
                .fontSize(14)
                .fontColor('#212121')
            }
            .alignItems(HorizontalAlign.Center)
          }
          .height(100)
          .layoutWeight(1)
          .backgroundColor('#F5F5F5')
          .borderRadius(6)
          .onClick(() => {
            router.pushUrl({
              url: 'pages/medical/AddMedicalRecordPage'
            });
          })
        }
        .width('100%')
        .padding({
          left: 16,
          right: 16,
          top: 8,
          bottom: 8
        })

        // ç–¾ç—…åˆ—è¡¨
        if (this.activeTemplates.length > 0) {
          Column({ space: 12 }) {
            ForEach(this.templates, (template: DiseaseTemplate) => {
              if (this.activeTemplates.includes(template.id)) {
                this.DiseaseCard(template, this.templateCounts.get(template.id) || 0);
              }
            })
          }
          .width('100%')
          .padding({ left: 16, right: 16, bottom: 16 })
        } else {
          Column() {
            Text('ó°–¿')
              .fontSize(30)
              .margin({ top: 40, bottom: 16 })

            Text('è¿˜æœªæ·»åŠ ä»»ä½•ç–¾ç—…')
              .fontSize(16)
              .fontColor('#9E9E9E')
              .margin({ bottom: 8 })

            Text('ç‚¹å‡»ä¸Šæ–¹"æ·»åŠ ç–¾ç—…"å¼€å§‹ç®¡ç†æ‚¨çš„æ…¢æ€§ç—…')
              .fontSize(13)
              .fontColor('#BDBDBD')
              .textAlign(TextAlign.Center)
              .padding({ left: 20, right: 20 })
          }
          .width('100%')
          .alignItems(HorizontalAlign.Center)
          .padding({ left: 16, right: 16, top: 40, bottom: 40 })
        }
      }
      .width('100%')
    }
    .layoutWeight(1)
    .backgroundColor('#F5F5F5')
  }

  @Builder
  HealthIndicatorCard(item: HealthIndicator) {
    Column({ space: 12 }) {
      // ç–¾ç—…æ ‡é¢˜
      Row() {
        Text(item.diseaseName)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#212121')
          .layoutWeight(1)

        Text('æœ€è¿‘è®°å½•')
          .fontSize(12)
          .fontColor('#BDBDBD')
      }
      .width('100%')

      // æŒ‡æ ‡æ•°æ®
      Row({ space: 12 }) {
        ForEach(item.indicators, (indicator: IndicatorItem) => {
          Column({ space: 4 }) {
            Text(indicator.name)
              .fontSize(12)
              .fontColor('#757575')

            Text(`${indicator.value}`)
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#212121')

            if (indicator.unit) {
              Text(indicator.unit)
                .fontSize(11)
                .fontColor('#9E9E9E')
            }
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Center)
        })
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
  }

  @Builder
  TodayMedicineContent() {
    if (this.todayMedicineRecords.length === 0) {
      Column() {
        Text('ğŸ’Š')
          .fontSize(80)
          .margin({ top: 100 })

        Text('ä»Šæ—¥æš‚æ— ç”¨è¯è®°å½•')
          .fontSize(16)
          .fontColor('#9E9E9E')
          .margin({ top: 16 })

        Text('æ·»åŠ è¯å“åä¼šè‡ªåŠ¨ç”Ÿæˆç”¨è¯è®°å½•')
          .fontSize(14)
          .fontColor('#BDBDBD')
          .margin({ top: 8 })
      }
      .width('100%')
      .layoutWeight(1)
    } else {
      Scroll() {
        Column({ space: 12 }) {
          // ä»Šæ—¥è¿›åº¦å¡ç‰‡
          Column({ space: 12 }) {
            Row() {
              Text('ä»Šæ—¥è¿›åº¦')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor('#757575')
                .layoutWeight(1)

              Text(`${this.getTakenCount()}/${this.todayMedicineRecords.length}`)
                .fontSize(14)
                .fontColor('#4CAF50')
            }
            .width('100%')

            Progress({
              value: this.getTakenCount(),
              total: this.todayMedicineRecords.length,
              type: ProgressType.Linear
            })
            .width('100%')
            .color('#4CAF50')
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .margin({ left: 16, right: 16, top: 12 })

          // ç”¨è¯è®°å½•åˆ—è¡¨
          Column({ space: 8 }) {
            ForEach(this.todayMedicineRecords, (record: MedicineRecord) => {
              this.MedicineRecordCard(record);
            })
          }
          .width('100%')
          .padding({ left: 16, right: 16, bottom: 16 })
        }
        .width('100%')
      }
      .layoutWeight(1)
    }
  }

  @Builder
  DiseaseCard(template: DiseaseTemplate, count: number) {
    Row() {
      // å›¾æ ‡
      Row() {
        Text(template.name.charAt(0))
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
      }
      .width(48)
      .height(48)
      .borderRadius(24)
      .backgroundColor(template.color)
      .justifyContent(FlexAlign.Center)
      .margin({ right: 12 })

      // ä¿¡æ¯
      Column({ space: 4 }) {
        Text(template.name)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#212121')

        Text(`å·²è®°å½• ${count} æ¬¡`)
          .fontSize(13)
          .fontColor('#9E9E9E')
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // æ—¥æœŸ
      Text(this.getLatestDateSync(template.id))
        .fontSize(12)
        .fontColor('#BDBDBD')
        .margin({ right: 8 })

      Image($r('sys.media.ohos_ic_public_arrow_right'))
        .width(20)
        .height(20)
        .fillColor('#BDBDBD')
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .onClick(() => {
      router.pushUrl({
        url: 'pages/disease/DiseaseManagePage',
        params: { templateId: template.id }
      });
    })
  }

  @Builder
  MedicineRecordCard(record: MedicineRecord) {
    Row() {
      Checkbox()
        .select(record.taken)
        .onChange(async (value: boolean) => {
          record.taken = value;
          record.takenTime = value ? Date.now() : 0;
          await HealthRecordDatabase.getInstance().saveMedicineRecord(record);
          await this.loadData();
        })
        .margin({ right: 12 })

      Column({ space: 4 }) {
        Text(record.medicineName)
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .fontColor('#212121')
          .decoration({ type: record.taken ? TextDecorationType.LineThrough : TextDecorationType.None })

        Text(this.getTimeName(record.time))
          .fontSize(12)
          .fontColor('#757575')
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      if (record.taken) {
        Image($r('sys.media.ohos_ic_public_ok'))
          .width(24)
          .height(24)
          .fillColor('#4CAF50')
      }
    }
    .width('100%')
    .padding(12)
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
  }

  getTimeName(time: string): string {
    switch (time) {
      case 'morning':
        return 'æ—©ä¸Š';
      case 'noon':
        return 'ä¸­åˆ';
      case 'evening':
        return 'æ™šä¸Š';
      case 'bedtime':
        return 'ç¡å‰';
      default:
        return time;
    }
  }

  getTakenCount(): number {
    return this.todayMedicineRecords.filter(r => r.taken).length;
  }

  getLatestDateSync(templateId: string): string {
    // åŒæ­¥æ–¹æ³•ï¼Œè¿”å›é»˜è®¤å€¼
    return '--';
  }

  async getLatestDate(templateId: string): Promise<string> {
    try {
      const latestRecord = await HealthRecordDatabase.getInstance().getLatestHealthRecord(templateId);
      if (latestRecord) {
        const date = new Date(latestRecord.date);
        return `${date.getMonth() + 1}/${date.getDate()}`;
      }
      return '--';
    } catch (err) {
      return '--';
    }
  }
}

