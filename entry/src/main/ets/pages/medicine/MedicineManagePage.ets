import router from '@ohos.router';
import { HealthDataManager } from '../../utils/HealthDataManager';
import { MedicineData, MedicineRecord, RemindTime } from '../../models/MedicineData';
import { promptAction } from '@kit.ArkUI';
import { NotificationManager } from '../../utils/NotificationManager';

@Entry
@Component
struct MedicineManagePage {
  @State currentTab: number = 0;
  @State medicineList: MedicineData[] = [];
  @State todayRecords: MedicineRecord[] = [];

  async aboutToAppear() {
    await this.loadData();
  }

  async loadData() {
    this.medicineList = await HealthDataManager.getInstance().getMedicineList();
    this.todayRecords = await HealthDataManager.getInstance().getMedicineRecords(Date.now());
  }

  onPageShow() {
    this.loadData();
  }

  async toggleRecordStatus(record: MedicineRecord) {
    record.taken = !record.taken;
    record.takenTime = record.taken ? Date.now() : 0;
    await HealthDataManager.getInstance().saveMedicineRecord(record);
    await this.loadData();
    promptAction.showToast({ message: record.taken ? 'å·²æ‰“å¡' : 'å·²å–æ¶ˆæ‰“å¡' });
  }

  build() {
    Column() {
      // å¯¼èˆªæ 
      Row() {
        Image($r('sys.media.ohos_ic_public_arrow_left'))
          .width(24)
          .height(24)
          .onClick(() => {
            router.back();
          })

        Text('ç”¨è¯ç®¡ç†')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
          .margin({ right: 24 })
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFFFFF')

      // Tabåˆ‡æ¢
      Tabs({ barPosition: BarPosition.Start, index: this.currentTab }) {
        TabContent() {
          this.TodayRecordsView();
        }
        .tabBar('ä»Šæ—¥ç”¨è¯')

        TabContent() {
          this.MedicineListView();
        }
        .tabBar('è¯å“åˆ—è¡¨')
      }
      .barMode(BarMode.Fixed)
      .layoutWeight(1)
      .onChange((index: number) => {
        this.currentTab = index;
      })

      // åº•éƒ¨æŒ‰é’®
      if (this.currentTab === 1) {
        Row() {
          Button('æ·»åŠ è¯å“')
            .width('100%')
            .backgroundColor('#FF9800')
            .onClick(() => {
              router.pushUrl({ url: 'pages/medicine/AddMedicinePage' });
            })
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#FFFFFF')
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  TodayRecordsView() {
    if (this.todayRecords.length === 0) {
      Column() {
        Text('â°')
          .fontSize(80)
          .margin({ top: 100 })
        
        Text('ä»Šæ—¥æš‚æ— ç”¨è¯è®°å½•')
          .fontSize(16)
          .fontColor('#9E9E9E')
          .margin({ top: 16 })
        
        Text('æ·»åŠ è¯å“åŽä¼šè‡ªåŠ¨ç”Ÿæˆç”¨è¯è®°å½•')
          .fontSize(14)
          .fontColor('#BDBDBD')
          .margin({ top: 8 })
        
        Button('æ·»åŠ è¯å“')
          .width(200)
          .height(48)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .backgroundColor('#FF9800')
          .borderRadius(24)
          .margin({ top: 40 })
          .onClick(() => {
            router.pushUrl({ url: 'pages/medicine/AddMedicinePage' });
          })
      }
      .width('100%')
      .height('100%')
    } else {
      Scroll() {
        Column({ space: 12 }) {
          // ç»Ÿè®¡ä¿¡æ¯
          Row() {
            Column() {
              Text(`${this.todayRecords.filter(r => r.taken).length}`)
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor('#4CAF50')
              
              Text('å·²æœç”¨')
                .fontSize(12)
                .fontColor('#757575')
            }
            .layoutWeight(1)

            Column() {
              Text(`${this.todayRecords.filter(r => !r.taken).length}`)
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor('#FF9800')
              
              Text('å¾…æœç”¨')
                .fontSize(12)
                .fontColor('#757575')
            }
            .layoutWeight(1)

            Column() {
              Text(`${this.todayRecords.length}`)
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor('#2196F3')
              
              Text('æ€»è®¡')
                .fontSize(12)
                .fontColor('#757575')
            }
            .layoutWeight(1)
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)

          // ç”¨è¯è®°å½•åˆ—è¡¨
          ForEach(this.todayRecords, (record: MedicineRecord) => {
            this.RecordCard(record);
          })
        }
        .padding(16)
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F5F5F5')
    }
  }

  @Builder
  MedicineListView() {
    if (this.medicineList.length === 0) {
      Column() {
        Text('ðŸ’Š')
          .fontSize(80)
          .margin({ top: 100 })
        
        Text('æš‚æ— è¯å“')
          .fontSize(16)
          .fontColor('#9E9E9E')
          .margin({ top: 16 })
        
        Text('ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ è¯å“')
          .fontSize(14)
          .fontColor('#BDBDBD')
          .margin({ top: 8 })
      }
      .width('100%')
      .height('100%')
    } else {
      List({ space: 12 }) {
        ForEach(this.medicineList, (medicine: MedicineData) => {
          ListItem() {
            this.MedicineCard(medicine);
          }
        })
      }
      .width('100%')
      .height('100%')
      .padding(16)
      .backgroundColor('#F5F5F5')
    }
  }

  @Builder
  RecordCard(record: MedicineRecord) {
    Row() {
      Checkbox()
        .select(record.taken)
        .onChange((value: boolean) => {
          this.toggleRecordStatus(record);
        })
        .margin({ right: 12 })

      Column({ space: 4 }) {
        Text(record.medicineName)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1F1F1F')
          .decoration({ type: record.taken ? TextDecorationType.LineThrough : TextDecorationType.None })
        
        Text(this.getTimeName(record.time))
          .fontSize(12)
          .fontColor('#757575')
        
        if (record.taken && record.takenTime > 0) {
          Text(`å·²äºŽ ${new Date(record.takenTime).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })} æ‰“å¡`)
            .fontSize(11)
            .fontColor('#4CAF50')
        }
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      if (record.taken) {
        Image($r('sys.media.ohos_ic_public_ok'))
          .width(24)
          .height(24)
          .fillColor('#4CAF50')
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
  }

  @Builder
  MedicineCard(medicine: MedicineData) {
    Column({ space: 8 }) {
      Row() {
        Text(medicine.name)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1F1F1F')
          .layoutWeight(1)

        Text('Ã—')
          .fontSize(24)
          .fontColor('#F44336')
          .fontWeight(FontWeight.Bold)
          .onClick(async () => {
            await HealthDataManager.getInstance().deleteMedicine(medicine.id);
            // å–æ¶ˆè¯¥è¯å“çš„æ‰€æœ‰æé†’
            await this.cancelMedicineReminders(medicine);
            await this.loadData();
            promptAction.showToast({ message: 'åˆ é™¤æˆåŠŸ' });
          })
      }
      .width('100%')

      if (medicine.specification) {
        Text(`è§„æ ¼ï¼š${medicine.specification}`)
          .fontSize(12)
          .fontColor('#757575')
          .width('100%')
      }

      if (medicine.dosage) {
        Text(`ç”¨æ³•ç”¨é‡ï¼š${medicine.dosage}`)
          .fontSize(12)
          .fontColor('#757575')
          .width('100%')
      }

      Row() {
        Text('æœç”¨æ—¶é—´ï¼š')
          .fontSize(12)
          .fontColor('#757575')
        
        Text(medicine.frequency.map((f: string) => {
          const timeName = this.getTimeName(f);
          const reminderTime = medicine.reminderTimes.get(f);
          if (reminderTime) {
            const hour = String(reminderTime.hour).padStart(2, '0');
            const minute = String(reminderTime.minute).padStart(2, '0');
            return `${timeName}(${hour}:${minute})`;
          }
          return timeName;
        }).join('ã€'))
          .fontSize(12)
          .fontColor($r('app.color.primary'))
          .fontColor($r('app.color.primary'))
      }
      .width('100%')

      Row() {
        Text(`ç”¨è¯å‘¨æœŸï¼š${new Date(medicine.startDate).toLocaleDateString('zh-CN')} è‡³ ${new Date(medicine.endDate).toLocaleDateString('zh-CN')}`)
          .fontSize(12)
          .fontColor('#757575')
          .layoutWeight(1)
        
        if (medicine.stock > 0) {
          Text(`åº“å­˜ï¼š${medicine.stock}`)
            .fontSize(12)
            .fontColor(medicine.stock < 10 ? '#F44336' : '#4CAF50')
        }
      }
      .width('100%')

      if (medicine.note) {
        Text(`å¤‡æ³¨ï¼š${medicine.note}`)
          .fontSize(12)
          .fontColor('#757575')
          .width('100%')
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
  }
  
  getTimeName(time: string): string {
    switch (time) {
      case 'morning':
        return 'æ—©ä¸Š';
      case 'noon':
        return 'ä¸­åˆ';
      case 'evening':
        return 'æ™šä¸Š';
      case 'bedtime':
        return 'ç¡å‰';
      default:
        return time;
    }
  }

  // å–æ¶ˆè¯å“æé†’
  async cancelMedicineReminders(medicine: MedicineData) {
    const notificationMgr = NotificationManager.getInstance();
    
    for (const time of medicine.frequency) {
      const reminderId = parseInt(medicine.id.substring(0, 8), 36) + time.charCodeAt(0);
      await notificationMgr.cancelReminder(reminderId);
    }
  }
}

