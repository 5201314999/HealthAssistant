import router from '@ohos.router';
import { HealthRecordDatabase } from '../../utils/HealthRecordDatabase';
import { MedicineData, MedicineRecord } from '../../models/MedicineData';
import { promptAction } from '@kit.ArkUI';
import { NotificationManager } from '../../utils/NotificationManager';
import { hilog } from '@kit.PerformanceAnalysisKit';

const TAG = 'MedicineTabPage';
const DOMAIN = 0x0000;

@Component
export struct MedicineTabPage {
  @State currentTab: number = 0;
  @State medicineList: MedicineData[] = [];
  @State todayRecords: MedicineRecord[] = [];

  async aboutToAppear() {
    hilog.debug(DOMAIN, TAG, 'aboutToAppear');
    await this.loadData();
  }

  onPageShow() {
    hilog.debug(DOMAIN, TAG, 'onPageShow - reloading data');
    this.loadData();
  }

  async loadData() {
    try {
      this.medicineList = await HealthRecordDatabase.getInstance().getMedicineList();
      this.todayRecords = await HealthRecordDatabase.getInstance().getMedicineRecords(Date.now());
      hilog.info(DOMAIN, TAG, 'Data loaded: %{public}d medicines, %{public}d today records', 
        this.medicineList.length, this.todayRecords.length);
    } catch (err) {
      hilog.error(DOMAIN, TAG, 'Failed to load data: %{public}s', JSON.stringify(err));
    }
  }

  async toggleRecordStatus(record: MedicineRecord) {
    record.taken = !record.taken;
    record.takenTime = record.taken ? Date.now() : 0;
    await HealthRecordDatabase.getInstance().saveMedicineRecord(record);
    await this.loadData();
    promptAction.showToast({ message: record.taken ? 'å·²æ‰“å¡' : 'å·²å–æ¶ˆæ‰“å¡' });
  }

  getTakenCount(): number {
    return this.todayRecords.filter(r => r.taken).length;
  }

  getCompletionRate(): number {
    if (this.todayRecords.length === 0) return 0;
    return Math.round((this.getTakenCount() / this.todayRecords.length) * 100);
  }

  @Builder
  TabBarItem(title: string, active: boolean) {
    Column() {
      Text(title)
        .fontSize(16)
        .fontWeight(active ? FontWeight.Medium : FontWeight.Normal)
        .fontColor(active ? $r('app.color.primary') : '#757575')
      if (active) {
        Divider()
          .strokeWidth(3)
          .color($r('app.color.primary'))
          .width(60)
          .margin({ top: 8 })
      }
    }
    .height(48)
    .justifyContent(FlexAlign.Center)
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Text('ç”¨è¯ç®¡ç†')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFFFFF')

      // Tabs å®˜æ–¹å®žçŽ°
      Tabs({ barPosition: BarPosition.Start, index: this.currentTab }) {
        TabContent() {
          this.MedicineReminderContent()
        }
        .tabBar(this.TabBarItem('ç”¨è¯æé†’', this.currentTab === 0))

        TabContent() {
          this.MyMedicineContent()
        }
        .tabBar(this.TabBarItem('æˆ‘çš„ç”¨è¯', this.currentTab === 1))
      }
      .barMode(BarMode.Fixed)
      .onChange((index: number) => {
        this.currentTab = index;
      })
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  @Builder
  MedicineReminderContent() {
    Column() {
      // æ—¥æœŸå’Œå®Œæˆåº¦
      Row() {
        Row({ space: 8 }) {
          Image($r('app.media.calendar'))
            .width(20)
            .height(20)
            .fillColor('#757575')

          Text(this.getTodayDateString())
            .fontSize(14)
            .fontColor('#757575')
        }
        .layoutWeight(1)

        Text(`${this.getCompletionRate()}% å®Œæˆ`)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#4CAF50')
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FFFFFF')

      if (this.todayRecords.length === 0) {
        // ç©ºçŠ¶æ€
        Column() {
          Column({ space: 16 }) {
            Text('ä»Šæ—¥è¿›åº¦')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#212121')
              .width('100%')

            Text(`å·²å®Œæˆ 0 / 0 æ¬¡ç”¨è¯`)
              .fontSize(14)
              .fontColor('#757575')
              .width('100%')
          }
          .width('100%')
          .padding(20)
          .backgroundColor('#F8F9FA')
          .borderRadius(12)
          .margin({ left: 16, right: 16, top: 16 })

          Column({ space: 16 }) {
            Text('ä»Šæ—¥æé†’')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#212121')
              .width('100%')

            Column() {
              Text('ðŸ’Š')
                .fontSize(60)
                .margin({ top: 40 })

              Text('æš‚æ— ç”¨è¯æé†’')
                .fontSize(14)
                .fontColor('#BDBDBD')
                .margin({ top: 16, bottom: 40 })

              Button('+ æ·»åŠ è¯å“')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor('#FFFFFF')
                .backgroundColor($r('app.color.primary'))
                .width(200)
                .height(48)
                .borderRadius(24)
                .onClick(() => {
                  router.pushUrl({ url: 'pages/medicine/AddMedicinePage' });
                })
            }
            .width('100%')
          }
          .width('100%')
          .padding(20)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .margin({ left: 16, right: 16, top: 16 })
        }
        .width('100%')
        .layoutWeight(1)
      } else {
        Scroll() {
          Column({ space: 16 }) {
            // ä»Šæ—¥è¿›åº¦å¡ç‰‡
            Column({ space: 16 }) {
              Text('ä»Šæ—¥è¿›åº¦')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .fontColor('#212121')
                .width('100%')

              Row() {
                Column({ space: 8 }) {
                  Text(`${this.getCompletionRate()}%`)
                    .fontSize(48)
                    .fontWeight(FontWeight.Bold)
                    .fontColor($r('app.color.primary'))

                  Text(`å·²å®Œæˆ ${this.getTakenCount()} / ${this.todayRecords.length} æ¬¡ç”¨è¯`)
                    .fontSize(13)
                    .fontColor('#757575')
                }
                .alignItems(HorizontalAlign.Start)
                .layoutWeight(1)

                Progress({
                  value: this.getTakenCount(),
                  total: this.todayRecords.length,
                  type: ProgressType.Ring
                })
                .width(80)
                .height(80)
                .color($r('app.color.primary'))
              }
              .width('100%')
            }
            .width('100%')
            .padding(20)
            .backgroundColor('#F8F9FA')
            .borderRadius(12)
            .margin({ left: 16, right: 16, top: 16 })

            // ä»Šæ—¥æé†’åˆ—è¡¨
            Column({ space: 12 }) {
              Text('ä»Šæ—¥æé†’')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .fontColor('#212121')
                .width('100%')
                .padding({ left: 16 })

              ForEach(this.todayRecords, (record: MedicineRecord) => {
                this.RecordCard(record);
              })
            }
            .width('100%')
            .padding({ bottom: 16 })
          }
          .width('100%')
        }
        .layoutWeight(1)
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  MyMedicineContent() {
    Column() {
      if (this.medicineList.length === 0) {
        Column() {
          Column({ space: 8 }) {
            Text('0')
              .fontSize(48)
              .fontWeight(FontWeight.Bold)
              .fontColor('#212121')

            Text('æ­£åœ¨æœç”¨çš„è¯å“')
              .fontSize(14)
              .fontColor('#757575')
          }
          .width('100%')
          .padding(20)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .margin({ left: 16, right: 16, top: 16 })

          Column() {
            Text('ðŸ’Š')
              .fontSize(60)
              .margin({ top: 40 })

            Text('æš‚æ— è¯å“è®°å½•')
              .fontSize(14)
              .fontColor('#BDBDBD')
              .margin({ top: 16, bottom: 40 })

            Button('+ æ·»åŠ è¯å“')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#FFFFFF')
              .backgroundColor($r('app.color.primary'))
              .width(200)
              .height(48)
              .borderRadius(24)
              .onClick(() => {
                router.pushUrl({ url: 'pages/medicine/AddMedicinePage' });
              })
          }
          .width('100%')
          .padding(20)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .margin({ left: 16, right: 16, top: 16 })
        }
        .width('100%')
        .layoutWeight(1)
      } else {
        Column() {
          // è¯å“æ•°é‡ç»Ÿè®¡
          Row() {
            Column({ space: 8 }) {
              Text(`${this.medicineList.length}`)
                .fontSize(48)
                .fontWeight(FontWeight.Bold)
                .fontColor('#212121')

              Text('æ­£åœ¨æœç”¨çš„è¯å“')
                .fontSize(14)
                .fontColor('#757575')
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)

            Button('+ æ·»åŠ è¯å“')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor('#FFFFFF')
              .backgroundColor($r('app.color.primary'))
              .height(44)
              .borderRadius(22)
              .onClick(() => {
                router.pushUrl({ url: 'pages/medicine/AddMedicinePage' });
              })
          }
          .width('100%')
          .padding(20)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .margin({ left: 16, right: 16, top: 16 })

          // è¯å“åˆ—è¡¨
          Scroll() {
            Column({ space: 12 }) {
              ForEach(this.medicineList, (medicine: MedicineData) => {
                this.MedicineCard(medicine);
              })
            }
            .width('100%')
            .padding({ left: 16, right: 16, top: 16, bottom: 16 })
          }
          .layoutWeight(1)
        }
        .width('100%')
        .height('100%')
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  RecordCard(record: MedicineRecord) {
    Row() {
      Checkbox()
        .select(record.taken)
        .onChange((value: boolean) => {
          this.toggleRecordStatus(record);
        })
        .margin({ right: 12 })

      Column({ space: 4 }) {
        Text(record.medicineName)
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .fontColor('#212121')
          .decoration({ type: record.taken ? TextDecorationType.LineThrough : TextDecorationType.None })

        Text(this.getTimeName(record.time))
          .fontSize(12)
          .fontColor('#757575')

        if (record.taken && record.takenTime > 0) {
          Text(`å·²äºŽ ${new Date(record.takenTime).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })} æ‰“å¡`)
            .fontSize(11)
            .fontColor('#4CAF50')
        }
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      if (record.taken) {
        Image($r('sys.media.ohos_ic_public_ok'))
          .width(24)
          .height(24)
          .fillColor('#4CAF50')
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .margin({ left: 16, right: 16 })
  }

  @Builder
  MedicineCard(medicine: MedicineData) {
    Column({ space: 12 }) {
      Row() {
        Text(medicine.name)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#212121')
          .layoutWeight(1)

        Text('Ã—')
          .fontSize(24)
          .fontColor('#F44336')
          .fontWeight(FontWeight.Bold)
          .onClick(async () => {
            await HealthRecordDatabase.getInstance().deleteMedicine(medicine.id);
            await this.cancelMedicineReminders(medicine);
            await this.loadData();
            promptAction.showToast({ message: 'åˆ é™¤æˆåŠŸ' });
          })
      }
      .width('100%')

      if (medicine.specification) {
        Text(`è§„æ ¼ï¼š${medicine.specification}`)
          .fontSize(13)
          .fontColor('#757575')
          .width('100%')
      }

      if (medicine.dosage) {
        Text(`ç”¨æ³•ç”¨é‡ï¼š${medicine.dosage}`)
          .fontSize(13)
          .fontColor('#757575')
          .width('100%')
      }

      Row() {
        Text('æœç”¨æ—¶é—´ï¼š')
          .fontSize(13)
          .fontColor('#757575')

        Text(medicine.frequency.map((f: string) => {
          const timeName = this.getTimeName(f);
          const reminderTime = medicine.reminderTimes[f];
          if (reminderTime) {
            const hour = String(reminderTime.hour).padStart(2, '0');
            const minute = String(reminderTime.minute).padStart(2, '0');
            return `${timeName}(${hour}:${minute})`;
          }
          return timeName;
        }).join('ã€'))
          .fontSize(13)
          .fontColor($r('app.color.primary'))
      }
      .width('100%')

      Row() {
        Text(`ç”¨è¯å‘¨æœŸï¼š${new Date(medicine.startDate).toLocaleDateString('zh-CN')} è‡³ ${new Date(medicine.endDate).toLocaleDateString('zh-CN')}`)
          .fontSize(12)
          .fontColor('#757575')
          .layoutWeight(1)

        if (medicine.stock > 0) {
          Text(`åº“å­˜ï¼š${medicine.stock}`)
            .fontSize(12)
            .fontColor(medicine.stock < 10 ? '#F44336' : '#4CAF50')
        }
      }
      .width('100%')

      if (medicine.note) {
        Text(`å¤‡æ³¨ï¼š${medicine.note}`)
          .fontSize(12)
          .fontColor('#757575')
          .width('100%')
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
  }

  getTimeName(time: string): string {
    switch (time) {
      case 'morning':
        return 'æ—©ä¸Š';
      case 'noon':
        return 'ä¸­åˆ';
      case 'evening':
        return 'æ™šä¸Š';
      case 'bedtime':
        return 'ç¡å‰';
      default:
        return time;
    }
  }

  getTodayDateString(): string {
    const today = new Date();
    return `${today.getFullYear()}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
  }

  async cancelMedicineReminders(medicine: MedicineData) {
    const notificationMgr = NotificationManager.getInstance();

    for (const time of medicine.frequency) {
      const reminderId = parseInt(medicine.id.substring(0, 8), 36) + time.charCodeAt(0);
      await notificationMgr.cancelReminder(reminderId);
    }
  }
}

